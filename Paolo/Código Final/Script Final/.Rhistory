require(pacman)
p_load(foreign, tidyverse, rio, here, dplyr, viridis, readxl, stringr, RColorBrewer, ggcorrplot,
flextable, officer, classInt, foreign, stargazer, sf, mapview, leaflet, writexl, lmtest,
tseries, car, haven, officer, xlsx, openxlsx, httr)
rm(list = ls())
require(pacman)
p_load(foreign, tidyverse, rio, here, dplyr, viridis, readxl, stringr, RColorBrewer, ggcorrplot,
flextable, officer, classInt, foreign, stargazer, sf, mapview, leaflet, writexl, lmtest,
tseries, car, haven, officer, xlsx, openxlsx, httr)
rm(list = ls())
###################################
###### Informes de sanción ########
###################################
# Carga de las bases antiguas
url1 <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20Finales/Informes_2022.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
GET(url1, write_disk(temp_file, overwrite = TRUE))
Consolidado1 <- read_excel(temp_file, sheet = "Componentes")
Consolidado1$Año <- 2022
rm(temp_file, url1)
url2 <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20Finales/Informes_2023.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
GET(url2, write_disk(temp_file, overwrite = TRUE))
Consolidado2 <- read_excel(temp_file, sheet = "Componentes")
Consolidado2$Año <- 2023
rm(temp_file, url2)
url3 <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20Finales/Informes_2024.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
GET(url3, write_disk(temp_file, overwrite = TRUE))
Consolidado3 <- read_excel(temp_file, sheet = "Componentes")
Consolidado3$Año <- 2024
rm(temp_file, url3)
# Carga de las bases nuevas
url4 <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20Finales/Info_2022.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
GET(url4, write_disk(temp_file, overwrite = TRUE))
Consolidado4 <- read_excel(temp_file, sheet = "Consolidado")
Consolidado4$Año <- 2022
rm(temp_file, url4)
url5 <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20Finales/Info_2023.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
GET(url5, write_disk(temp_file, overwrite = TRUE))
Consolidado5 <- read_excel(temp_file, sheet = "Consolidado")
Consolidado5$Año <- 2023
rm(temp_file, url5)
url6 <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20Finales/Info_2024.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
GET(url6, write_disk(temp_file, overwrite = TRUE))
Consolidado6 <- read_excel(temp_file, sheet = "Consolidado")
Consolidado6$Año <- 2024
rm(temp_file, url6)
# Carga de información de RUIAS
url7 <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20sustento/RUIAS-CSEP.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
GET(url7, write_disk(temp_file, overwrite = TRUE))
RUIAS <- read_excel(temp_file, sheet = "RUIAS")
rm(temp_file, url7)
# Consolidando la información
Antigua <- rbind(Consolidado1, Consolidado2, Consolidado3)
rm(Consolidado1, Consolidado2, Consolidado3)
Nueva <- rbind(Consolidado4, Consolidado5, Consolidado6)
rm(Consolidado4, Consolidado5, Consolidado6)
# Filtrando la información necesaria
Antigua <- Antigua %>%
filter(Detalle != "Eliminar" | is.na(Detalle))
Antigua <- Antigua %>%
filter(Filtro=="Cálculo de multa")
Nueva <- Nueva %>%
filter(Filtro=="Cálculo de multa")
# Edición de base Antigua
colnames(Antigua)[colnames(Antigua) == "Sub_extremo"] <- "Extremo"
Antigua <- Antigua %>% select(-Detalle, -Observaciones)
Antigua$Datos <- "Primera fase"
# Edición de base Nueva
Nueva <- Nueva %>% select(-"Sub extremo")
Nueva$Datos <- "Segunda fase"
# Append principal
CFinal <- rbind(Antigua, Nueva)
# Ediciones extra
colnames(CFinal)[colnames(CFinal) == "ID"] <- "Index"
CFinal$Index <- as.character(CFinal$Index)
colnames(CFinal)[colnames(CFinal) == "Expedientes"] <- "Expediente"
rm(Antigua, Nueva)
# Seleccionando las variables a usar
RFinal <- RUIAS %>% dplyr::select("ID", "Administrado", "RUC", "Sector económico", "Departamento",
"Provincia", "Distrito", "Infracción cometida sancionada (Clasificación de 11)",
"Infracción cometida sancionada (Clasificación de 19)",
"Inicio de supervisión", "Fin de supervisión", "Fecha de notificación...23",
"Documento de inicio", "Fecha de emisión",
"N° de Resolución de Responsabilidad Administrativa", "Fecha de la Resolución...38",
"Fecha de notificación...39")
colnames(RFinal)[colnames(RFinal) == "ID"] <- "Index"
colnames(RFinal)[colnames(RFinal) == "Sector económico"] <- "SectorEco"
colnames(RFinal)[colnames(RFinal) == "Inicio de supervisión"] <- "InicioSup"
colnames(RFinal)[colnames(RFinal) == "Fin de supervisión"] <- "FinSup"
colnames(RFinal)[colnames(RFinal) == "Fecha de notificación...23"] <- "InicioPAS"
colnames(RFinal)[colnames(RFinal) == "Infracción cometida sancionada (Clasificación de 11)"] <- "Incumplimiento_11"
colnames(RFinal)[colnames(RFinal) == "Infracción cometida sancionada (Clasificación de 19)"] <- "Incumplimiento_19"
colnames(RFinal)[colnames(RFinal) == "Fecha de notificación...23"] <- "Fecha_Notificacion_23"
colnames(RFinal)[colnames(RFinal) == "Fecha de notificación...39"] <- "Fecha_Notificacion_39"
colnames(RFinal)[colnames(RFinal) == "Fecha de la Resolución...38"] <- "Fecha_Resolucion"
colnames(RFinal)[colnames(RFinal) == "N° de Resolución de Responsabilidad Administrativa"] <- "Nro_Resolucion"
colnames(RFinal)[colnames(RFinal) == "Documento de inicio"] <- "Documento_Inicio"
colnames(RFinal)[colnames(RFinal) == "Fecha de emisión"] <- "Fecha_Emision"
RFinal$Index <- as.character(RFinal$Index)
# Fusionando ambas bases
CFinal$Index[is.na(CFinal$Index)] <- 0
FINAL <-left_join(x = CFinal, y = RFinal, by="Index")
FINAL <- FINAL %>%
mutate(Merge = if_else(!is.na(Departamento), 1, 0))
# Eliminando los objetos que no necesitamos
rm(CFinal, RFinal, RUIAS)
# Arreglando las etiquetas de los sectores
FINAL$Sancion_total <- as.numeric(FINAL$Sancion_total)
FINAL$Multa_Final <- as.numeric(FINAL$Multa_Final)
FINAL$Prob_Detección <- as.numeric(FINAL$Prob_Detección)
FINAL$Beneficio_ilícito <- as.numeric(FINAL$Beneficio_ilícito)
FINAL$T_meses <- as.numeric(FINAL$T_meses)
FINAL <- FINAL %>%
mutate(SectorEco = tolower(SectorEco))
FINAL$SectorEco <- sapply(FINAL$SectorEco, function(x) {
paste(toupper(substr(x, 1, 1)), tolower(substr(x, 2, nchar(x))), sep = "")
})
FINAL <- FINAL %>% filter(Multa_Final != 0)
# Quedándome solo con los que fusionaron perfecto con el RUIAS
table(FINAL$Merge)
# Fusionando el Tipo de Empresa (restante: Index 7020)
url8 <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/Bases/Exceles/Tipo_Empresas.xlsx"
temp_file <- tempfile(fileext = ".xlsx")
GET(url8, write_disk(temp_file, overwrite = TRUE))
Tamaño <- read_excel(temp_file, sheet = "Final")
rm(temp_file, url8)
FINAL <-left_join(x = FINAL, y = Tamaño, by="Administrado")
rm(Tamaño)
#View(FINAL[is.na(FINAL$tipo_actividad), ])
FINAL$tipo_actividad <- ifelse(FINAL$Index == "7020", "actividad empresarial", FINAL$tipo_actividad)
FINAL$tipo_persona <- ifelse(FINAL$Index == "7020", "persona jurídica", FINAL$tipo_persona)
table(FINAL$tipo_actividad)
FINAL$Colapsar <- ifelse(FINAL$Colapsar == "Máximo", "Maximo", FINAL$Colapsar)
table(FINAL$Colapsar)
###################################
###### Fechas de informes #########
###################################
# Bucle para descargar y leer los archivos por año
years <- c(2022, 2023, 2024)
for (year in years) {
url <- paste0("https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/Fechas/Fecha_", year, ".xlsx")
temp_file <- tempfile(fileext = ".xlsx")
GET(url, write_disk(temp_file, overwrite = TRUE))
assign(paste0("F", year), read_excel(temp_file, sheet = as.character(year)))
rm(temp_file, url)
}
rm(year, years)
Fechas1 <- rbind(F2022, F2023, F2024)
rm(F2022, F2023, F2024)
Fechas1 <- Fechas1 %>% dplyr::select(Informes, Fecha_Informe)
years <- c(2022, 2023, 2024)
for (year in years) {
url <- paste0("https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/Fechas/Fecha_", year, "b.xlsx")
temp_file <- tempfile(fileext = ".xlsx")
GET(url, write_disk(temp_file, overwrite = TRUE))
assign(paste0("F", year), read_excel(temp_file, sheet = as.character(year)))
rm(temp_file, url)
}
rm(year, years)
Fechas2 <- rbind(F2022, F2023, F2024)
colnames(Fechas2)[colnames(Fechas2) == "Fecha"] <- "Fecha_Informe"
Fechas2 <- Fechas2 %>% dplyr::select(Informes, Fecha_Informe)
rm(F2022, F2023, F2024)
Fechas <- rbind(Fechas1, Fechas2)
rm(Fechas1, Fechas2)
FINAL <-left_join(x = FINAL, y = Fechas, by="Informes")
rm(Fechas)
#table(is.na(FINAL$Fecha_Informe))
#View(FINAL[is.na(FINAL$Fecha_Informe), ])
###################################
##### Factores de graduación ######
###################################
years <- c(2022, 2023, 2024)
Factores <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20Finales/Informes_"
for (year in years) {
url <- paste0(Factores, year, ".xlsx")
temp_file <- tempfile(fileext = ".xlsx")
GET(url, write_disk(temp_file, overwrite = TRUE))
assign(paste0("G", year), read_excel(temp_file, sheet = "Graduacion"))
rm(temp_file, url)
}
rm(Factores, year, years)
# Quitando de las bases las categorías a no emplear
G2022$Observaciones <- NULL
G2024$Observaciones <- NULL
# Haciendo un append
Aglomerado1 <- rbind(G2022, G2023, G2024)
rm(G2022, G2023, G2024)
table(Aglomerado1$Detalle)
Aglomerado1 <- Aglomerado1 %>%
filter(Detalle != "Eliminar")
table(Aglomerado1$Filtro)
Aglomerado1 <- Aglomerado1 %>%
filter(Filtro=="Cálculo de multa")
# Selecionando las variables a emplear
Aglomerado1 <- Aglomerado1 %>% dplyr::select("ID","Informes", "Imputacion", "Factores_agravantes", "Categoria_FA", "% FA")
table(Aglomerado1$Factores_agravantes, useNA = "ifany")
# Importando Los nuevos Factores de la segunda tanda de informes
years <- c(2022, 2023, 2024)
Factores <- "https://raw.githubusercontent.com/PaoloValcarcel/OEFA_SMER/main/Paolo/C%C3%B3digo%20Final/Bases%20Finales/Info_"
for (year in years) {
url <- paste0(Factores, year, ".xlsx")
temp_file <- tempfile(fileext = ".xlsx")
GET(url, write_disk(temp_file, overwrite = TRUE))
assign(paste0("G", year), read_excel(temp_file, sheet = "Graduación"))
rm(temp_file, url)
}
rm(Factores, year, years)
Aglomerado2 <- rbind(G2022, G2023, G2024)
rm(G2022, G2023, G2024)
table(Aglomerado2$Filtro)
Aglomerado2 <- Aglomerado2 %>%
filter(Filtro=="Cálculo de multa")
colnames(Aglomerado2)[colnames(Aglomerado2) == "Correlativo"] <- "ID"
Aglomerado2 <- Aglomerado2 %>% dplyr::select("ID","Informes", "Imputacion", "Factores_agravantes", "Categoria_FA", "% FA")
Aglomerado1$Datos <- "Primera fase"
Aglomerado2$Datos <- "Segunda fase"
# Combinando los factores
FACTORES <- rbind(Aglomerado1, Aglomerado2)
rm(Aglomerado1, Aglomerado2)
FACTORES <- FACTORES %>%
mutate(`% FA` = ifelse(is.na(Categoria_FA), 0, `% FA`))
###################################
###### Exportando las bases #######
###################################
FINAL <- FINAL %>% dplyr::select(-c("Hecho_imputado"))
wb <- createWorkbook()
# Añadiendo la primera hoja con el primer dataframe
addWorksheet(wb, "Informes")
writeData(wb, "Informes", FINAL, colNames = TRUE)
# Añadiendo la segunda hoja con el segundo dataframe
addWorksheet(wb, "Factores")
writeData(wb, "Factores", FACTORES, colNames = TRUE)
# Guardardando el archivo Excel
saveWorkbook(wb, "D:/LAPTOP ACER/REPOSITORIO_GITHUB/OEFA_SMER/Paolo/Código Final/Bases Finales/INFORMES_GRADUACION.xlsx", overwrite = TRUE)
